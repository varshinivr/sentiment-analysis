{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "arn:aws:iam::242201274954:oidc-provider/gitlab.com"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringEquals": {
                    "gitlab.com:sub": "project_path:sample1292341/OIDC-AWS:ref_type:branch:ref:main"
                }
            }
        }
    ]
}


assume-role-example:
  image: 
    name: amazon/aws-cli:latest
    entrypoint: [""]
  id_tokens:
    MY_OIDC_TOKEN:
      aud: https://gitlab.com
  variables:
    AWS_DEFAULT_REGION: us-east-1
    AWS_PROFILE: oidc  
  before_script:
    - mkdir -p ~/.aws
   # - echo "${CI_JOB_JWT_V2}" > /tmp/web_identity_token
    - echo "${MY_OIDC_TOKEN}" > /tmp/web_identity_token
    - echo -e "[profile oidc]\nrole_arn=arn:aws:iam::242201274954:role/oidc-role\nweb_identity_token_file=/tmp/web_identity_token\nregion=us-east-1" > ~/.aws/config
  script:
    - aws sts get-caller-identity   
    - aws ec2 describe-instances


